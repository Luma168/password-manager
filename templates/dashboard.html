{% extends "base.html" %}

{% block title %}Tableau de bord - Gestionnaire de Mots de Passe{% endblock %}

{% block body_class %}dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Mes Mots de Passe</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPasswordModal">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="input-group">
                <span class="input-group-text bg-white">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" class="form-control" id="searchInput" placeholder="Rechercher un mot de passe...">
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Titre</th>
                            <th>Nom d'utilisateur</th>
                            <th>Catégorie</th>
                            <th>Dernière modification</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for password in passwords %}
                        <tr data-category="{{ password.category or '' }}">
                            <td class="fw-medium">{{ password.title }}</td>
                            <td>{{ password.username }}</td>
                            <td>
                                <span class="badge bg-secondary text-white">
                                    {{ password.category.name or 'Non catégorisé' }}
                                </span>
                            </td>
                            <td class="text-muted">{{ password.last_modified.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td class="text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary view-password" data-id="{{ password.id }}" title="Voir">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning edit-password" data-id="{{ password.id }}" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-password" data-id="{{ password.id }}" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajout de mot de passe -->
<div class="modal fade" id="addPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un mot de passe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPasswordForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="title" class="form-label">Titre</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Nom d'utilisateur</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Mot de passe</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" required>
                            <button class="btn btn-outline-secondary toggle-password" type="button">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="generatePassword">
                                <i class="fas fa-random"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Catégorie</label>
                        <div class="input-group">
                            <select class="form-select" id="category" name="category_id">
                                <option value="">Sans catégorie</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">
                                    <i class="{{ category.icon }}"></i> {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#categoryModal">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Ajouter des notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="savePassword">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Édition de mot de passe -->
<div class="modal fade" id="editPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier le mot de passe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPasswordForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="edit_id" name="id">
                    <div class="mb-3">
                        <label for="edit_title" class="form-label">Titre</label>
                        <input type="text" class="form-control" id="edit_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_username" class="form-label">Nom d'utilisateur</label>
                        <input type="text" class="form-control" id="edit_username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_password" class="form-label">Mot de passe</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="edit_password" name="password" required>
                            <button class="btn btn-outline-secondary toggle-password" type="button">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="generateEditPassword">
                                <i class="fas fa-random"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_category" class="form-label">Catégorie</label>
                        <div class="input-group">
                            <select class="form-select" id="edit_category" name="category_id">
                                <option value="">Sans catégorie</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">
                                    <i class="{{ category.icon }}"></i> {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#categoryModal">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="edit_notes" name="notes" rows="3" placeholder="Ajouter des notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="updatePassword">Mettre à jour</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Affichage du mot de passe -->
<div class="modal fade" id="viewPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Détails du mot de passe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Titre</label>
                    <p id="view_title" class="form-control-static"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Nom d'utilisateur</label>
                    <p id="view_username" class="form-control-static"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Mot de passe</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="view_password" readonly>
                        <button class="btn btn-outline-secondary toggle-password" type="button">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Catégorie</label>
                    <p id="view_category" class="form-control-static"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <p id="view_notes" class="form-control-static"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Menu contextuel personnalisé -->
<div id="contextMenu" class="context-menu" style="display: none;">
    <div class="context-menu-item" data-action="copy-username">
        <i class="fas fa-user me-2"></i>Copier le nom d'utilisateur
    </div>
    <div class="context-menu-item" data-action="copy-password">
        <i class="fas fa-key me-2"></i>Copier le mot de passe
    </div>
    <div class="context-menu-item" data-action="copy-notes">
        <i class="fas fa-sticky-note me-2"></i>Copier les notes
    </div>
    <div class="context-menu-item" data-action="share-password">
        <i class="fas fa-share-alt"></i> Partager le mot de passe
    </div>
</div>

<!-- Add this modal for sharing -->
<div class="modal fade" id="sharePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Partager le mot de passe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="expirationDateTime" class="form-label">Date et heure d'expiration</label>
                    <input type="datetime-local" class="form-control" id="expirationDateTime" required>
                    <div class="form-text">Le lien sera valable jusqu'à cette date et heure.</div>
                </div>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="shareUrl" readonly>
                    <button class="btn btn-outline-secondary" type="button" id="copyShareUrl">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Le lien expirera le <span id="shareExpiry"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmShare">Partager</button>
            </div>
        </div>
    </div>
</div>

<!-- Add this modal for category management -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gérer les catégories</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Nom de la catégorie</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Icône</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="iconSearch" placeholder="Rechercher une icône...">
                        </div>
                        <div class="icon-grid" style="max-height: 300px; overflow-y: auto;">
                            <div class="row g-2" id="iconGrid">
                                <!-- Icons will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </form>
                <hr>
                <h6>Catégories existantes</h6>
                <div id="categoriesList" class="list-group">
                    {% for category in categories %}
                    <div class="list-group-item d-flex justify-content-between align-items-center" data-category-id="{{ category.id }}">
                        <div>
                            <i class="{{ category.icon }} me-2"></i>
                            {{ category.name }}
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-primary edit-category" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}" data-category-icon="{{ category.icon }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-category" data-category-id="{{ category.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="addCategoryBtn">Ajouter</button>
            </div>
        </div>
    </div>
</div>

<style>
.table th {
    font-weight: 600;
    font-size: 0.875rem;
    background-color: #f8f9fa;
}

.table td {
    font-size: 0.875rem;
}

.badge {
    font-weight: 500;
    padding: 0.5em 0.75em;
}

.btn-group .btn {
    padding: 0.25rem 0.5rem;
}

/* Context menu styles */
.context-menu {
    position: fixed;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 200px;
    display: none;
}

.context-menu-item {
    padding: 8px 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    color: #333;
}

.context-menu-item:hover {
    background-color: #f8f9fa;
}

.context-menu-item i {
    width: 20px;
    text-align: center;
}

.icon-grid {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
}

.icon-item {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 40px;
    cursor: pointer;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.icon-item:hover {
    background-color: #f8f9fa;
}

.icon-item.selected {
    background-color: #e9ecef;
    border: 2px solid #0d6efd;
}

.icon-item i {
    font-size: 1.25rem;
}
</style>

<script>
// Initialize variables at the top
let currentPasswordId = null;
let shareModal;
let contextMenu;
let selectedRow = null;

// Function to copy text to clipboard
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-success position-fixed top-0 end-0 m-3';
        notification.style.zIndex = '9999';
        notification.textContent = 'Copié dans le presse-papiers !';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 2000);
    } catch (err) {
        console.error('Erreur lors de la copie:', err);
    }
}

// Function to share password
async function sharePassword(passwordId) {
    // Show the modal first
    shareModal.show();
    
    // Store the password ID for later use
    currentPasswordId = passwordId;
}

// Function to confirm share
async function confirmShare() {
    try {
        const expirationDateTime = document.getElementById('expirationDateTime').value;
        if (!expirationDateTime) {
            alert('Veuillez sélectionner une date et heure d\'expiration');
            return;
        }

        const response = await fetch(`/share_password/${currentPasswordId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ 
                expires_at: expirationDateTime
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Erreur lors du partage');
        }

        const data = await response.json();
        
        // Update the share URL input
        document.getElementById('shareUrl').value = data.share_url;
        
        // Format the expiration date in Paris timezone
        const expiryDate = new Date(data.expires_at);
        document.getElementById('shareExpiry').textContent = expiryDate.toLocaleString('fr-FR', {
            timeZone: 'Europe/Paris',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Show success message
        const notification = document.createElement('div');
        notification.className = 'alert alert-success position-fixed top-0 end-0 m-3';
        notification.style.zIndex = '9999';
        notification.textContent = 'Mot de passe partagé avec succès !';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 2000);
    } catch (error) {
        console.error('Erreur:', error);
        alert(error.message || 'Erreur lors du partage du mot de passe');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals and other elements
    shareModal = new bootstrap.Modal(document.getElementById('sharePasswordModal'));
    contextMenu = document.getElementById('contextMenu');
    
    // Set minimum datetime to current time in Paris timezone
    const now = new Date();
    const parisOffset = 120; // Paris is UTC+2
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset() + parisOffset);
    document.getElementById('expirationDateTime').min = now.toISOString().slice(0, 16);
    
    // Add right-click event listeners to table rows
    document.querySelectorAll('tbody tr').forEach(row => {
        row.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            selectedRow = this;
            currentPasswordId = this.querySelector('.view-password').dataset.id;
            
            // Position the context menu
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
        });
    });

    // Add click event listener for context menu items
    contextMenu.addEventListener('click', async function(e) {
        const action = e.target.closest('.context-menu-item')?.dataset.action;
        if (!action || !selectedRow) return;

        try {
            const response = await fetch(`/get_password/${currentPasswordId}`);
            const data = await response.json();
            
            if (data.success) {
                if (action === 'copy-username') {
                    await copyToClipboard(data.password.username);
                } else if (action === 'copy-password') {
                    await copyToClipboard(data.password.password);
                } else if (action === 'copy-notes') {
                    await copyToClipboard(data.password.notes || '');
                } else if (action === 'share-password') {
                    await sharePassword(currentPasswordId);
                }
            }
        } catch (error) {
            console.error('Erreur:', error);
        }
        
        contextMenu.style.display = 'none';
    });

    // Close context menu when clicking outside
    document.addEventListener('click', function(e) {
        if (!contextMenu.contains(e.target)) {
            contextMenu.style.display = 'none';
        }
    });

    // Add event listener for confirm share button
    document.getElementById('confirmShare').addEventListener('click', confirmShare);

    // ... rest of your existing DOMContentLoaded code ...
});

// Fonction pour générer un mot de passe aléatoire
function generateRandomPassword() {
    const length = 16;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?";
    let password = "";
    for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * charset.length);
        password += charset[randomIndex];
    }
    return password;
}

// Gestionnaire pour le bouton de génération de mot de passe
document.getElementById('generatePassword').addEventListener('click', function() {
    document.getElementById('password').value = generateRandomPassword();
});

document.getElementById('generateEditPassword').addEventListener('click', function() {
    document.getElementById('edit_password').value = generateRandomPassword();
});

// Gestionnaire pour la recherche
document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchText = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const title = row.cells[0].textContent.toLowerCase();
        const username = row.cells[1].textContent.toLowerCase();
        const category = row.cells[2].textContent.toLowerCase();
        
        if (title.includes(searchText) || username.includes(searchText) || category.includes(searchText)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Gestionnaire pour l'ajout de mot de passe
document.getElementById('savePassword').addEventListener('click', function() {
    const form = document.getElementById('addPasswordForm');
    const formData = new FormData(form);
    
    fetch('/add_password', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur lors de l\'ajout du mot de passe');
        }
    });
});

// Gestionnaire pour la suppression de mot de passe
document.querySelectorAll('.delete-password').forEach(button => {
    button.addEventListener('click', function() {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce mot de passe ?')) {
            const id = this.dataset.id;
            fetch(`/delete_password/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erreur lors de la suppression du mot de passe');
                }
            });
        }
    });
});

// Gestionnaire pour l'édition de mot de passe
document.querySelectorAll('.edit-password').forEach(button => {
    button.addEventListener('click', function() {
        const id = this.dataset.id;
        // Récupérer les données du mot de passe
        fetch(`/get_password/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit_id').value = data.password.id;
                document.getElementById('edit_title').value = data.password.title;
                document.getElementById('edit_username').value = data.password.username;
                document.getElementById('edit_category').value = data.password.category || '';
                document.getElementById('edit_notes').value = data.password.notes || '';
                
                const editModal = new bootstrap.Modal(document.getElementById('editPasswordModal'));
                editModal.show();
            }
        });
    });
});

// Gestionnaire pour la mise à jour du mot de passe
document.getElementById('updatePassword').addEventListener('click', function() {
    const form = document.getElementById('editPasswordForm');
    const formData = new FormData(form);
    
    fetch('/update_password', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur lors de la mise à jour du mot de passe');
        }
    });
});

// Fonction pour basculer la visibilité du mot de passe
function togglePasswordVisibility(input, button) {
    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
    input.setAttribute('type', type);
    const icon = button.querySelector('i');
    icon.classList.toggle('fa-eye');
    icon.classList.toggle('fa-eye-slash');
}

// Ajouter les gestionnaires d'événements pour les boutons de visibilité
document.querySelectorAll('.toggle-password').forEach(button => {
    button.addEventListener('click', function() {
        const input = this.previousElementSibling;
        togglePasswordVisibility(input, this);
    });
});

// Gestionnaire pour l'affichage du mot de passe
document.querySelectorAll('.view-password').forEach(button => {
    button.addEventListener('click', function() {
        const id = this.dataset.id;
        // Récupérer les données du mot de passe
        fetch(`/get_password/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('view_title').textContent = data.password.title;
                document.getElementById('view_username').textContent = data.password.username;
                document.getElementById('view_password').value = data.password.password;
                document.getElementById('view_category').textContent = data.password.category.name || 'Non catégorisé';
                document.getElementById('view_notes').textContent = data.password.notes || '';
                
                const viewModal = new bootstrap.Modal(document.getElementById('viewPasswordModal'));
                viewModal.show();
            } else {
                alert('Erreur lors de la récupération du mot de passe');
            }
        });
    });
});

// Gestionnaire pour le filtrage par catégorie
document.querySelectorAll('.category-filter').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Mettre à jour la classe active
        document.querySelectorAll('.category-filter').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        
        const category = this.dataset.category;
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            if (category === '' || row.dataset.category === category) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});

// Add this to handle copying the share URL
document.getElementById('copyShareUrl').addEventListener('click', function() {
    const shareUrl = document.getElementById('shareUrl');
    shareUrl.select();
    document.execCommand('copy');
    
    // Show notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-success position-fixed top-0 end-0 m-3';
    notification.style.zIndex = '9999';
    notification.textContent = 'Lien copié !';
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 2000);
});

// Category management
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...

    // Add category
    document.getElementById('addCategoryBtn').addEventListener('click', addCategory);

    // Delete category
    document.addEventListener('click', async function(e) {
        if (e.target.closest('.delete-category')) {
            const categoryId = e.target.closest('.delete-category').dataset.categoryId;
            const categoryName = e.target.closest('.list-group-item').querySelector('div').textContent.trim();
            
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette catégorie ? Les mots de passe de cette catégorie seront marqués comme non catégorisés.')) {
                return;
            }

            try {
                const response = await fetch(`/delete_category/${categoryId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    // Remove category from the sidebar list
                    const sidebarCategory = document.querySelector(`.sidebar .list-group a[href="/dashboard?category=${categoryId}"]`);
                    if (sidebarCategory) {
                        sidebarCategory.remove();
                    }

                    // Remove category from the categories list in the modal
                    const categoryElement = document.querySelector(`[data-category-id="${categoryId}"]`);
                    if (categoryElement) {
                        categoryElement.remove();
                    }

                    // Remove category from select elements
                    const selects = document.querySelectorAll('select[name="category_id"]');
                    selects.forEach(select => {
                        const option = select.querySelector(`option[value="${categoryId}"]`);
                        if (option) option.remove();
                    });

                    // Update passwords in the table that had this category
                    const rows = document.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const categoryCell = row.querySelector('td:nth-child(3) .badge');
                        if (categoryCell && categoryCell.textContent.trim() === categoryName) {
                            categoryCell.textContent = 'Non catégorisé';
                            categoryCell.classList.remove('bg-secondary');
                            categoryCell.classList.add('bg-secondary');
                            row.dataset.category = ''; // Update the row's data-category attribute
                        }
                    });

                    showAlert('Catégorie supprimée avec succès', 'success');
                } else {
                    throw new Error(data.error || 'Erreur lors de la suppression de la catégorie');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert(error.message || 'Erreur lors de la suppression de la catégorie', 'danger');
            }
        }
    });

    // Add edit category functionality
    document.addEventListener('click', async function(e) {
        if (e.target.closest('.edit-category')) {
            const button = e.target.closest('.edit-category');
            const categoryId = button.dataset.categoryId;
            const categoryName = button.dataset.categoryName;
            const categoryIcon = button.dataset.categoryIcon;
            
            // Set the form values
            document.getElementById('categoryName').value = categoryName;
            selectedIcon = categoryIcon;
            populateIconGrid();
            
            // Change the add button to update
            const addButton = document.getElementById('addCategoryBtn');
            addButton.textContent = 'Mettre à jour';
            addButton.onclick = () => updateCategory(categoryId);
            
            // Scroll to the form
            document.getElementById('categoryName').scrollIntoView({ behavior: 'smooth' });
        }
    });
});

async function updateCategory(categoryId) {
    const name = document.getElementById('categoryName').value;
    
    if (!name) {
        showAlert('Veuillez entrer un nom de catégorie', 'danger');
        return;
    }
    
    try {
        const response = await fetch(`/update_category/${categoryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                name: name,
                icon: selectedIcon
            })
        });

        const data = await response.json();
        
        if (data.success) {
            // Update the category in the sidebar
            const sidebarCategory = document.querySelector(`.sidebar .list-group a[href="/dashboard?category=${categoryId}"]`);
            if (sidebarCategory) {
                sidebarCategory.innerHTML = `
                    <span><i class="${selectedIcon} me-2"></i>${name}</span>
                    <span class="badge bg-primary rounded-pill">0</span>
                `;
            }
            
            // Update the category in the modal list
            const categoryElement = document.querySelector(`[data-category-id="${categoryId}"]`);
            if (categoryElement) {
                categoryElement.querySelector('div').innerHTML = `
                    <i class="${selectedIcon} me-2"></i>
                    ${name}
                `;
            }
            
            // Update the category in all select elements
            const selects = document.querySelectorAll('select[name="category_id"]');
            selects.forEach(select => {
                const option = select.querySelector(`option[value="${categoryId}"]`);
                if (option) {
                    option.innerHTML = `<i class="${selectedIcon}"></i> ${name}`;
                }
            });
            
            // Reset the form and button
            document.getElementById('categoryName').value = '';
            selectedIcon = 'fas fa-globe';
            populateIconGrid();
            
            const addButton = document.getElementById('addCategoryBtn');
            addButton.textContent = 'Ajouter';
            addButton.onclick = addCategory;
            
            showAlert('Catégorie mise à jour avec succès', 'success');
        } else {
            throw new Error(data.error || 'Erreur lors de la mise à jour de la catégorie');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert(error.message || 'Erreur lors de la mise à jour de la catégorie', 'danger');
    }
}

function addCategory() {
    const form = document.getElementById('addCategoryForm');
    const formData = new FormData();
    
    // Get the category name and icon
    const name = document.getElementById('categoryName').value;
    
    if (!name) {
        showAlert('Veuillez entrer un nom de catégorie', 'danger');
        return;
    }
    
    // Add the form data
    formData.append('name', name);
    formData.append('icon', selectedIcon);
    formData.append('csrf_token', document.querySelector('meta[name="csrf-token"]').content);
    
    fetch('/add_category', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur réseau');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Add the new category to the sidebar list
            const categoriesList = document.querySelector('.sidebar .list-group');
            const newCategory = document.createElement('a');
            newCategory.href = `/dashboard?category=${data.category.id}`;
            newCategory.className = 'list-group-item list-group-item-action bg-dark text-white d-flex justify-content-between align-items-center';
            newCategory.innerHTML = `
                <span><i class="${data.category.icon} me-2"></i>${data.category.name}</span>
                <span class="badge bg-primary rounded-pill">0</span>
            `;
            categoriesList.appendChild(newCategory);
            
            // Add the new category to the categories list in the modal
            const modalCategoriesList = document.getElementById('categoriesList');
            const newModalCategory = document.createElement('div');
            newModalCategory.className = 'list-group-item d-flex justify-content-between align-items-center';
            newModalCategory.setAttribute('data-category-id', data.category.id);
            newModalCategory.innerHTML = `
                <div>
                    <i class="${data.category.icon} me-2"></i>
                    ${data.category.name}
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-primary edit-category" data-category-id="${data.category.id}" data-category-name="${data.category.name}" data-category-icon="${data.category.icon}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-category" data-category-id="${data.category.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            modalCategoriesList.appendChild(newModalCategory);
            
            // Add the new category to all category select elements
            const selects = document.querySelectorAll('select[name="category_id"]');
            const option = document.createElement('option');
            option.value = data.category.id;
            option.innerHTML = `<i class="${data.category.icon}"></i> ${data.category.name}`;
            
            selects.forEach(select => {
                select.appendChild(option.cloneNode(true));
            });
            
            // Reset the form and icon selection
            form.reset();
            selectedIcon = 'fas fa-globe';
            populateIconGrid();
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
            modal.hide();
            
            // Show success message
            showAlert('Catégorie ajoutée avec succès', 'success');
        } else {
            throw new Error(data.error || 'Erreur lors de l\'ajout de la catégorie');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert(error.message || 'Erreur lors de l\'ajout de la catégorie', 'danger');
    });
}

// Add this function if it doesn't exist
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}

// Icon grid functionality
const iconGrid = document.getElementById('iconGrid');
const iconSearch = document.getElementById('iconSearch');
let selectedIcon = 'fas fa-globe';

// List of available icons
const icons = [
    'fas fa-globe', 'fas fa-user', 'fas fa-key', 'fas fa-credit-card',
    'fas fa-envelope', 'fas fa-lock', 'fas fa-shield-alt', 'fas fa-folder',
    'fas fa-heart', 'fas fa-camera', 'fas fa-music', 'fas fa-video',
    'fas fa-palette', 'fas fa-code', 'fas fa-database', 'fas fa-server',
    'fas fa-network-wired', 'fas fa-gamepad', 'fas fa-book', 'fas fa-newspaper',
    'fas fa-shopping-cart', 'fas fa-utensils', 'fas fa-car', 'fas fa-plane',
    'fas fa-train', 'fas fa-bus', 'fas fa-bicycle', 'fas fa-running',
    'fas fa-dumbbell', 'fas fa-swimming-pool', 'fas fa-hiking', 'fas fa-mountain',
    'fas fa-briefcase', 'fas fa-lightbulb', 'fas fa-cloud', 'fas fa-cogs',
    'fas fa-wrench', 'fas fa-bell', 'fas fa-comments', 'fas fa-gift',
    'fas fa-home', 'fas fa-building', 'fas fa-calendar-alt', 'fas fa-check-circle',
    'fas fa-exclamation-circle', 'fas fa-info-circle', 'fas fa-question-circle',
    'fas fa-search', 'fas fa-star', 'fas fa-tag', 'fas fa-thumbs-up',
    'fas fa-trash', 'fas fa-upload', 'fas fa-download', 'fas fa-wifi',
    'fas fa-paperclip', 'fas fa-map-marker-alt', 'fas fa-phone', 'fas fa-print',
    'fas fa-rocket', 'fas fa-trophy', 'fas fa-medkit', 'fas fa-flask',
    'fas fa-coffee', 'fas fa-tree', 'fas fa-fire', 'fas fa-sun',
    'fas fa-moon', 'fas fa-snowflake', 'fas fa-smile', 'fas fa-frown'
];

// Populate icon grid
function populateIconGrid(filter = '') {
    iconGrid.innerHTML = '';
    icons
        .filter(icon => icon.toLowerCase().includes(filter.toLowerCase()))
        .forEach(icon => {
            const col = document.createElement('div');
            col.className = 'col-3';
            col.innerHTML = `
                <div class="icon-item ${selectedIcon === icon ? 'selected' : ''}" data-icon="${icon}">
                    <i class="${icon}"></i>
                </div>
            `;
            iconGrid.appendChild(col);
        });

    // Add click handlers
    document.querySelectorAll('.icon-item').forEach(item => {
        item.addEventListener('click', () => {
            selectedIcon = item.dataset.icon;
            document.querySelectorAll('.icon-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
        });
    });
}

// Search functionality
iconSearch.addEventListener('input', (e) => {
    populateIconGrid(e.target.value);
});

// Initialize icon grid
populateIconGrid();

// Update form submission to use selected icon
document.getElementById('addCategoryForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    formData.set('categoryIcon', selectedIcon);
    // ... rest of the form submission code ...
});
</script>
{% endblock %} 